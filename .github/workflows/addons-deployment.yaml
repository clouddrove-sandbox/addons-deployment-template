name: Shared AKS Addon Helm Template

on:
  workflow_call:
    inputs:
      environment_name:
        required: true
        type: string

      aks_rg:
        required: true
        type: string

      aks_cluster_name:
        required: true
        type: string

      addon_name:
        required: true
        type: string

      helm_release_name:
        required: true
        type: string

      helm_namespace:
        required: true
        type: string

      helm_chart:
        required: true
        type: string

      helm_repo_name:
        required: false
        type: string
        default: ""

      helm_repo_url:
        required: false
        type: string
        default: ""

      helm_values_file:
        required: true
        type: string

      token_prefix:
        required: false
        type: string
        default: "#{"

      token_suffix:
        required: false
        type: string
        default: "}#"

    secrets:
      AZURE_CREDENTIALS:
        required: true
      helm_set_args:
        required: false
      token_env:
        required: true

jobs:
  deploy_addon:
    runs-on: ${{ inputs.runs-on || 'ubuntu-latest' }}

    # Prod approval is enforced here via GitHub Environments settings
    environment:
      name: ${{ inputs.environment_name }}

    # Hard guard: prod only from main
    # if: ${{ inputs.environment_name != 'prod' || github.ref == 'refs/heads/master' }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure CLI dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y curl unzip ca-certificates gnupg lsb-release git

          if ! command -v az >/dev/null 2>&1; then
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          fi

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup kubectl and Helm    
        uses: azure/setup-kubectl@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Install kubelogin
        run: |
          set -e
          curl -LO https://github.com/Azure/kubelogin/releases/latest/download/kubelogin-linux-amd64.zip
          sudo apt-get install -y unzip
          unzip -o kubelogin-linux-amd64.zip
          sudo mv -f bin/linux_amd64/kubelogin /usr/local/bin/kubelogin

      - uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ inputs.aks_rg }}
          cluster-name:   ${{ inputs.aks_cluster_name }}

      - name: kubelogin convert-kubeconfig
        run: kubelogin convert-kubeconfig -l azurecli

      - name: Export token env vars
        run: |
          set -e
          cat << 'EOF' >> "$GITHUB_ENV"
          ${{ secrets.token_env }}
          EOF

      # Render values to a temp file so the repo file stays untouched
      - name: Render Helm values to temp
        id: render
        run: |
          set -euo pipefail
          SRC="${{ inputs.helm_values_file }}"
          test -f "$SRC" || (echo "Missing values file: $SRC" && exit 1)
          OUT="${RUNNER_TEMP}/${{ inputs.addon_name }}-${{ inputs.environment_name }}-values.yaml"
          cp "$SRC" "$OUT"
          echo "rendered_values=$OUT" >> "$GITHUB_OUTPUT"

      - name: Replace tokens in rendered values
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["${{ steps.render.outputs.rendered_values }}"]'
          tokenPrefix: "#{"
          tokenSuffix: "}#"

      - name: Add Helm repo (optional)
        if: ${{ inputs.helm_repo_name != '' && inputs.helm_repo_url != '' }}
        run: |
          set -e
          helm repo add "${{ inputs.helm_repo_name }}" "${{ inputs.helm_repo_url }}"
          helm repo update

      - name: Deploy Helm Release
        env:
          HELM_SET_ARGS: ${{ secrets.helm_set_args }}
        run: |
          set -euo pipefail

          echo "Deploying addon=${{ inputs.addon_name }} env=${{ inputs.environment_name }}"
          echo "Using HELM_SET_ARGS: ${HELM_SET_ARGS:+(provided)}"

          helm upgrade --install "${{ inputs.helm_release_name }}" "${{ inputs.helm_chart }}" \
            --namespace "${{ inputs.helm_namespace }}" --create-namespace \
            -f "${{ steps.render.outputs.rendered_values }}" \
            ${HELM_SET_ARGS}

      # Remove runtime secrets/material after deploy
      - name: Cleanup rendered values + env
        if: always()
        run: |
          set -e
          FILE="${{ steps.render.outputs.rendered_values }}"
          if [ -f "$FILE" ]; then
            shred -u "$FILE" 2>/dev/null || rm -f "$FILE"
          fi
